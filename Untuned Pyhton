import pygame
import serial
import sys
import math

# Initialize Pygame
pygame.init()

# Set up the display
width, height = 800, 600
screen = pygame.display.set_mode((width, height))
pygame.display.set_caption("Etch-a-Sketch")
screen.fill((255, 255, 255))  # Fill the screen with white

# Cursor position
x, y = width // 2, height // 2
speed = 1  # Cursor speed

# Previous cursor position
prev_x, prev_y = x, y

# Initialize the serial port
ser = serial.Serial('COM7', 115200)  # Update with the correct COM port and baud rate

# Angle and turning speed
angle = 90
turn_speed = 4  # Degrees per input

# Game loop
running = True
while running:
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

    # Read joystick values from the serial port
    data = ser.readline().decode().strip()
    if data:
        x_volts, y_volts = map(float, data.split(','))

        # Calculate speed and direction based on joystick inputs
        if y_volts < 1.6:
            speed = -(y_volts - 1.6) * 1  # Reverse speed
        elif y_volts > 1.65:
            speed = -(y_volts - 1.65) * 1  # Forward speed
        else:
            speed = 0  # Neutral

           # Calculate the angle of the robot's movement
        if x_volts >= 1.60 and x_volts <= 1.62:  # Neutral, hold direction
            pass
        elif x_volts < 0.3:
            angle = (angle + turn_speed) % 360  # Spin left
            speed = 0;
        elif x_volts >= 0.3 and x_volts < 1.62:
            angle = (angle - turn_speed * (1.62 - x_volts)/1.6) % 360  # Slightly turn left
        elif x_volts > 1.62 and x_volts <= 3.0:
            angle = (angle + turn_speed * (x_volts - 1.62) / 1.58) % 360  # Slightly turn right
        elif x_volts >= 3.0:
            angle = (angle - turn_speed) % 360  # Spin right
            speed = 0;

       
        # Update cursor position based on speed and direction
        x += (speed * math.cos(angle * math.pi / 180))
        y += (speed * math.sin(angle * math.pi / 180))
        print(x,y,angle) 

        # Ensure the cursor stays within the screen bounds
        x = max(0, min(x, width - 1))
        y = max(0, min(y, height - 1))

        # Draw a line from the previous position to the current position
        pygame.draw.line(screen, (0, 0, 0), (prev_x, prev_y), (x, y))

        # Update the display
        pygame.display.flip()

        # Update the previous position
        prev_x, prev_y = x, y

# Close the serial port
ser.close()

# Quit Pygame
pygame.quit()
sys.exit()
